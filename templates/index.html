<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KPI & Join Analyzer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { background-color: #f9fafb; padding: 20px; }
    .card { margin-top: 20px; border-radius: 10px; }
    #joinPreview { max-height: 300px; overflow-y: auto; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">üìä Dataset Join + KPI Analyzer</h2>

    <!-- Upload Section -->
    <div class="card p-3">
      <h5>Step 1: Upload Datasets</h5>
      <div class="row g-2">
        <div class="col-md-6">
          <input type="file" id="file1" class="form-control" accept=".csv, .xlsx" />
        </div>
        <div class="col-md-6">
          <input type="file" id="file2" class="form-control" accept=".csv, .xlsx" />
        </div>
      </div>
      <button class="btn btn-primary mt-2" onclick="uploadDatasets()">Upload</button>
      <div id="columnStatus" class="mt-2 text-muted"></div>
    </div>

    <!-- Join Section -->
    <div class="card p-3" id="joinOptions" style="display:none;">
      <h5>Step 2: Join Datasets</h5>
      <select id="joinColumns" multiple class="form-select mb-2"></select>
      <select id="joinType" class="form-select mb-3">
        <option value="inner">Inner Join</option>
        <option value="left">Left Join</option>
        <option value="right">Right Join</option>
        <option value="outer">Full Outer Join</option>
      </select>
      <button class="btn btn-success" onclick="performJoin()">Perform Join</button>

      <!-- Join Preview -->
      <div id="joinPreview" class="table-responsive mt-3" style="display:none;">
        <h6>üîç Join Preview</h6>
        <table class="table table-sm table-bordered" id="joinTable"></table>
      </div>
    </div>

    <!-- KPI Section -->
    <div class="card p-3" id="kpiOptions" style="display:none;">
      <h5>Step 3: KPI Analysis</h5>
      <label>Select Dataset for KPI:</label>
      <select id="datasetSelect" class="form-select mb-3"></select>
      <button class="btn btn-info" onclick="analyzeKPI()">Analyze KPI</button>
    </div>

    <!-- KPI Results -->
    <div class="card p-3">
      <h5>üìà KPI Results</h5>
      <ul id="kpiList" class="list-group"></ul>
      <div id="chart" class="mt-4"></div>
    </div>

    <!-- üí° Tips Section -->
    <div class="card p-3 mt-4">
      <h5>üí° Improvement Tips</h5>
      <ul id="tipsList" class="list-group"></ul>
    </div>

    <!-- Export -->
    <div class="text-center mt-4">
      <button class="btn btn-success" id="exportBtn" onclick="exportExcel()" disabled>Export KPI Data</button>
    </div>
  </div>

  <script>
    async function uploadDatasets() {
      const file1 = document.getElementById("file1").files[0];
      const file2 = document.getElementById("file2").files[0];
      if (!file1 || !file2) return alert("Upload both datasets!");

      const formData = new FormData();
      formData.append("file1", file1);
      formData.append("file2", file2);

      const res = await fetch("/upload_datasets", { method: "POST", body: formData });
      const data = await res.json();

      document.getElementById("columnStatus").innerHTML =
        `<b>Common Columns:</b> ${data.common_columns.join(", ") || "None"}`;
      
      const datasetSelect = document.getElementById("datasetSelect");
      datasetSelect.innerHTML = `
        <option value="dataset1">Dataset 1 (${data.dataset1_cols.length} columns)</option>
        <option value="dataset2">Dataset 2 (${data.dataset2_cols.length} columns)</option>
        <option value="joined">Joined Dataset</option>
      `;
      
      document.getElementById("joinOptions").style.display = "block";
      document.getElementById("kpiOptions").style.display = "block";

      const joinSelect = document.getElementById("joinColumns");
      joinSelect.innerHTML = "";
      data.common_columns.forEach(col => {
        const opt = document.createElement("option");
        opt.value = col; opt.textContent = col;
        joinSelect.appendChild(opt);
      });
    }

    async function performJoin() {
      const joinCols = Array.from(document.getElementById("joinColumns").selectedOptions).map(o => o.value);
      const joinType = document.getElementById("joinType").value;
      if (joinCols.length === 0) return alert("Select at least one column for join.");

      const formData = new FormData();
      joinCols.forEach(c => formData.append("join_columns[]", c));
      formData.append("join_type", joinType);

      const res = await fetch("/process_join", { method: "POST", body: formData });
      const data = await res.json();

      const previewDiv = document.getElementById("joinPreview");
      const table = document.getElementById("joinTable");
      previewDiv.style.display = "block";
      table.innerHTML = "";

      if (data.joined_data && data.joined_data.length > 0) {
        const headers = Object.keys(data.joined_data[0]);
        const thead = `<tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>`;
        const rows = data.joined_data.slice(0, 10)
          .map(row => `<tr>${headers.map(h => `<td>${row[h]}</td>`).join("")}</tr>`)
          .join("");
        table.innerHTML = `<thead>${thead}</thead><tbody>${rows}</tbody>`;
      } else {
        table.innerHTML = "<tr><td>No data after join</td></tr>";
      }
    }

    async function analyzeKPI() {
      const dataset = document.getElementById("datasetSelect").value;
      const formData = new FormData();
      formData.append("dataset", dataset);

      const res = await fetch("/analyze_kpi", { method: "POST", body: formData });
      const data = await res.json();

      // === KPI Results ===
      const kpiList = document.getElementById("kpiList");
      kpiList.innerHTML = "";
      data.kpis.forEach(kpi => {
        const li = document.createElement("li");
        li.classList.add("list-group-item");
        li.textContent = `${kpi.name}: ${kpi.value}`;
        kpiList.appendChild(li);
      });

      // === Chart Fix ===
      const chartDiv = document.getElementById("chart");
      chartDiv.innerHTML = ""; // clear old chart
      if (data.chart_data && data.chart_data.length > 0 && data.category) {
        const x = data.chart_data.map(d => d[data.category]);
        const y = data.chart_data.map(d => d.Count);
        const trace = { x, y, type: "bar", marker: { color: "teal" } };
        const layout = {
          title: `üìä ${data.category} Trend`,
          xaxis: { title: data.category },
          yaxis: { title: "Count" },
          responsive: true
        };
        Plotly.newPlot("chart", [trace], layout);
      } else {
        chartDiv.innerHTML = "<p class='text-muted'>No chart data available.</p>";
      }

      // === Tips ===
      const tipsList = document.getElementById("tipsList");
      tipsList.innerHTML = "";
      if (data.tips && data.tips.length > 0) {
        data.tips.forEach(tip => {
          const li = document.createElement("li");
          li.classList.add("list-group-item");
          li.textContent = tip;
          tipsList.appendChild(li);
        });
      } else {
        tipsList.innerHTML = "<li class='list-group-item text-muted'>No improvement tips available.</li>";
      }

      document.getElementById("exportBtn").disabled = false;
    }

    async function exportExcel() {
      const res = await fetch("/export");
      const blob = await res.blob();
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "kpi_analysis.xlsx";
      link.click();
    }
  </script>
</body>
</html>
